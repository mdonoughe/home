---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: influx
  namespace: home
  annotations:
    fluxcd.io/automated: "true"
    fluxcd.io/tag.chart-image: semver:~1.7
spec:
  releaseName: home-influx
  chart:
    repository: https://kubernetes-charts.storage.googleapis.com/
    name: influxdb
    version: "3.0.1"
  values:
    image:
      repository: influxdb
      tag: "1.7.9"
    config:
      http:
        auth_enabled: true
    setDefaultUser:
      enabled: true
      user:
        username: home_assistant
    initScripts:
      enabled: true
      scripts:
        init.iql: |+
          CREATE DATABASE home_assistant
        rtlamr.iql: |+
          CREATE DATABASE rtlamr

          ALTER RETENTION POLICY "autogen" ON "rtlamr" DURATION 1w REPLICATION 1 SHARD DURATION 1h DEFAULT
          CREATE RETENTION POLICY "30d_1h"  ON "rtlamr" DURATION 30d REPLICATION 1 SHARD DURATION 1d
          CREATE RETENTION POLICY "5y_1d"  ON "rtlamr" DURATION 1825d REPLICATION 1 SHARD DURATION 30d
        rtlamr-query-hour.iql: |+
          CREATE CONTINUOUS QUERY "1h_power" ON "rtlamr"
          RESAMPLE EVERY 1h FOR 2h
          BEGIN
            SELECT non_negative_difference(max("consumption")) AS "consumption"
            INTO "30d_1h"."power"
            FROM "autogen"."rtlamr"
            WHERE "endpoint_type" = '7'
            GROUP BY time(1h), *
            TZ('Etc/UTC')
          END;
        rtlamr-query-day.iql: |+
          CREATE CONTINUOUS QUERY "1d_power" ON "rtlamr"
          RESAMPLE EVERY 1d FOR 2d
          BEGIN
            SELECT sum("consumption") AS "consumption"
            INTO "rtlamr"."5y_1d"."power"
            FROM "rtlamr"."30d_1h"."power"
            GROUP BY time(1d), *
            TZ('Etc/UTC')
          END;
    persistence:
      enabled: true
      accessMode: ReadWriteOnce
      size: 8Gi
      storageClass: local-storage
  valueFileSecrets:
    - name: influx-secret
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: influx-secret
  namespace: home
spec:
  encryptedData:
    values.yaml: AgA9ZzMN0NzyZuCdtf3x2IZR9J4vo+IULuRAdMUiEDFbAy7DaUZynWlw/2uPn/5cg1thOzjPopa9wmB3+QcPePpzpTztrIf0Gae4dKpmIgNNywUhj1PLGDLeJNxY9nbj5EDwRnSrFUNQleF7oW8aa35rxPBop+iVCRuKAJHcRNbab0NTRHYCP3d/3XZT0rUrrUDpMXJW2ZdvCB3ds5er+MHDMNDGkNovDHuwAo36hjHm5iA+alKHdZxA1qIPm2VrZdzhJtwt+3TC94TIumkucUVQSB9AOU8U6pDt6bSYTceliYNdEHF6zABB3Gsu4oVEdbQcJd38NEPWf2Zp0xaYwu4crFgVTeLP1vHKY8f1RSxZbTTliqknMUgOYgT+rXVFeYJobdrdbtarbk6sLcAqyjb3GYwQo73T+EIE9oH4BWDOTaOrgEiwe6K3WkL4Jdb2hoWL70ZeBem1+EpgdLv7k12wFrO4+ComtFiY69MHY0OCKJsKxsZ9K9L8RXaYdkeI3PMkhkYPSkSVYT8wzPvjfnEXpntnqwXrwtm65jeD2Qfx6fDekSqNkYpk8cExaMMKJz+DZ/joDTd8g0zNpG601kBITZJDt/OUNf/BSGwZEgKgZfQ9HWqvi8u6T6/oNSmWrWaAHNzKjYbGLh/XkuZfMQaN3WG8H0nohk0UR/F3CXdg3T97qI/P8S7rMLPVl5gKeOsYTkoFaG9wZyn9/551Qlf9dJxilqBowrYfGVwCzdasPFECGWjTV/r2BNiQB8nyIT9odoRHEBeL7ExS2bkEIXBqAoxMM706+9Z3Kg==
